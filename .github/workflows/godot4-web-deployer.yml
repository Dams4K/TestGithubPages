name: "godot4-web-deployer"
on: push

permissions:
  contents: write

env:
  # Basic Settings
  GODOT_MAJOR_MINOR_VERSION: "4.0" # must be a string, not a number
  GODOT_PATCH_VERSION: beta11

  PROJECT_FOLDER: .

  EXPORT_TEMPLATE: release # release || debug
  EXPORT_PRESET_NAME: Web
  EXPORT_FOLDER: build/
  EXPORT_FILENAME: index.html

  DEPLOYMENT_BRANCH: gh-pages

  # If you have a custom godot you may want to download your own godot
  GODOT_VERSION: ${GODOT_MAJOR_MINOR_VERSION}.${GODOT_PATCH_VERSION}
  
  #GODOT_EXECUTABLE_DOWNLOAD_URL: 
  #GODOT_TEMPLATES_DOWNLOAD_URL: 

jobs:
  export_web:
    runs-on: ubuntu-latest
    name: Export Web Game
    steps:
    - name: Checkout
      uses: actions/checkout@v3
    
    - name: Install Godot
      run: |
        # Download godot executable and templates
        curl https://downloads.tuxfamily.org/godotengine/${GODOT_MAJOR_MINOR_VERSION}/${GODOT_PATCH_VERSION}/Godot_v${GODOT_MAJOR_MINOR_VERSION}-${GODOT_PATCH_VERSION}_linux.x86_64.zip --output godot.zip
        curl https://downloads.tuxfamily.org/godotengine/${GODOT_MAJOR_MINOR_VERSION}/${GODOT_PATCH_VERSION}/Godot_v${GODOT_MAJOR_MINOR_VERSION}-${GODOT_PATCH_VERSION}_export_templates.tpz --output templates.tpz

        unzip godot.zip -d godot
        unzip templates.tpz

        # Create needed dirs
        # Templates with godot 4 must be in ~/.local/share/godot/export_templates/{MAJOR.MINOR.PATCH}
        mkdir -v -p ~/.local/share/godot/export_templates/${GODOT_VERSION}
        
        mv templates/* ~/.local/share/godot/export_templates/${GODOT_VERSION}
        mv godot/Godot* godot.x86_64

        # Just cleaning
        rm -R templates/
        rm templates.tpz
    
    - name: Build Project
      run: |
        tree
        mkdir -v -p ${EXPORT_FOLDER}
        cd ${PROJECT_FOLDER}

        # Exporting the game
        ~/godot.x86_64 --headless --path . --export-${EXPORT_TEMPLATE} ${EXPORT_PRESET_NAME} ~/${EXPORT_FOLDER}/{$EXPORT_FILENAME}
    
    - name: Add coi-service-worker
      run: |
        git clone https://github.com/gzuidhof/coi-serviceworker.git
        mv coi-serviceworker/coi-serviceworker.js ${EXPORT_FOLDER}/coi-serviceworker.js
    
    - name: Upload Artifact
      uses: actions/upload-artifact@v3
      with:
        name: ${EXPORT_PRESET_NAME}
        path: ${EXPORT_FOLDER}
    
    - name: Deploy to GitHub Pages ðŸš€
      uses: JamesIves/github-pages-deploy-action@v4
      with:
        branch: ${DEPLOYMENT_BRANCH}
        folder: ${EXPORT_FOLDER}